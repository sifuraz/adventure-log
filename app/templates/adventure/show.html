{% extends "nested_base.html" %}
{% block title %}{{ adventure.name }}{% endblock %}
{% block main_title %}{{ adventure.name }}{% endblock %}
{% block content %}
<section class="section">
    <div class="container">
        <div class="notification is-danger is-hidden" id="error">{{ error }}</div>
        <div>
            <div class="adventure-details">
                <p class="subheading">{{ adventure.type | replace("_", " ") | capitalize }}</p>
                <h3>Featuring:</h3>
                <ul>
                    {% for player in adventure.players %}
                    {% if player.role == "dm" %}
                    <!--TODO crown icon-->
                    <li>{{ player.username }} as Dungeon Master</li>
                    {% elif player.character %}
                    <li>{{ player.username }} as {{ player.character.name }}</li>
                    {% else %}
                    <li>{{ player.username }}</li>
                    {% endif %}
                    {% endfor %}
                </ul>
                {% if adventure.pending_invitations %}
                <h3>Pending Invitations:</h3>
                <ul>
                    {% for email in adventure.pending_invitations %}
                    <li>{{ email }}</li>
                    {% endfor %}
                </ul>
                {% endif %}
                <button class="button" id="invite-player-btn">Invite Player</button>
            </div>
        </div>
    </div>
</section>

<!-- Modal -->
<div class="modal" id="invite-player-modal">
    <div class="modal-background"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">Invite Player</p>
        </header>
        <section class="modal-card-body">
            <div class="notification is-danger is-hidden" id="modal-error">{{ error }}</div>
            <form id="invite-player-form">
                <div class="field">
                    <label class="label">Email</label>
                    <div class="control">
                        <input class="input" type="email" placeholder="Enter email" name="email" required>
                    </div>
                </div>
            </form>
        </section>
        <footer class="modal-card-foot">
            <button class="button is-success" type="submit" form="invite-player-form">Invite</button>
            <button class="button" id="cancel-modal-btn">Cancel</button>
        </footer>
    </div>
</div>
<script>
    // Get the modal element
    var modal = document.getElementById('invite-player-modal');

    // Get the button that opens the modal
    var btn = document.getElementById('invite-player-btn');

    // Get the cancel button
    var cancelBtn = document.getElementById('cancel-modal-btn');

    // When the user clicks the button, open the modal
    btn.onclick = function () {
        modal.classList.add('is-active');
    }

    // When the user clicks on the cancel button, close the modal
    cancelBtn.onclick = function () {
        modal.classList.remove('is-active');
    }

    const inviteForm = document.getElementById('invite-player-form');
    const modalError = document.getElementById('modal-error');

    // When the user submits the form, call the invite player endpoint
    inviteForm.addEventListener('submit', async (event) => {
        event.preventDefault();
        const formData = new FormData(inviteForm);
        const formJSON = Object.fromEntries(formData.entries());
        const adventureId = parseInt("{{ adventure.id }}");
        fetch('/adventure/invite', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                email: formJSON.email,
                adventure_id: adventureId
            })
        })
            .then(response => {
                if (response.status === 201) {
                    // Handle successful response
                    modal.classList.remove('is-active');
                    window.location.reload();
                } else if (response.status === 403 || response.status === 404) {
                    // Handle error response
                    return response.json();
                } else {
                    // Handle other error responses
                    throw new Error('An error occurred. Please try again later.');
                }
            })
            .then(errorMessage => {
                modalError.classList.remove('is-hidden');
                modalError.textContent = 'Error: ' + errorMessage.detail;
            })
            .catch(error => {
                modalError.classList.remove('is-hidden');
                modalError.textContent = error.message;
            });
    });
</script>
{% endblock %}
